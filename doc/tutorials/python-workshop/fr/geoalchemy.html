<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>GeoAlchemy &mdash; Python Workshop v0.1 documentation</title>
    <link rel="stylesheet" href="../static/mapfish.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <link rel="top" title="Python Workshop v0.1 documentation" href="../index.html" />
    <link rel="up" title="Workshop Python (version française)" href="index.html" />
    <link rel="next" title="TileCache" href="tilecache.html" />
    <link rel="prev" title="Pylons et SQLAlchemy" href="pylons.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="tilecache.html" title="TileCache"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="pylons.html" title="Pylons et SQLAlchemy"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Python Workshop v0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Workshop Python (version française)</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../static/mapfish_white.png" alt="Logo"/>
            </a></p>
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="#">GeoAlchemy</a><ul>
<li><a class="reference external" href="#installation">Installation</a></li>
<li><a class="reference external" href="#changer-le-model">Changer le model</a></li>
<li><a class="reference external" href="#changer-le-controlleur">Changer le contrôlleur</a></li>
<li><a class="reference external" href="#sortie-geojson">Sortie GeoJSON</a></li>
<li><a class="reference external" href="#calcul-du-buffer">Calcul du buffer</a></li>
<li><a class="reference external" href="#creer-des-features">Créer des features</a></li>
<li><a class="reference external" href="#creer-des-tables-geographiques">Créer des tables géographiques</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="pylons.html"
                                  title="previous chapter">Pylons et SQLAlchemy</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="tilecache.html"
                                  title="next chapter">TileCache</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/fr/geoalchemy.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="geoalchemy">
<h1>GeoAlchemy<a class="headerlink" href="#geoalchemy" title="Permalink to this headline">¶</a></h1>
<p>GeoAlchemy fournie des extensions à SQLAlchemy pour fonctionner avec des bases
de données spatiales. GeoAlchemy gère pour l&#8217;instant les bases PostGIS, MySQL,
Spatiallite, Oracle Locator et Microsoft SQL Server 2008.</p>
<p>Dans ce module vous apprendrez comment utiliser GeoAlchemy pour interagir avec
PostGIS.</p>
<p>Plus précisément, vous changerez la classe model <tt class="docutils literal"><span class="pre">Summit</span></tt> pour inclure la
colonne géométrie. Vous changerez également le contrôleur <tt class="docutils literal"><span class="pre">summits</span></tt> pour
renvoyer du WKT ou du GeoJSON, pour calculer des buffers et pour créer des
features dans la base de données.</p>
<p>Vous utiliserez également les bibliothèques <tt class="docutils literal"><span class="pre">geojson</span></tt> et <tt class="docutils literal"><span class="pre">Shapely</span></tt>.</p>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>Pour installer GeoAlchemy dans l&#8217;environnement virtuel Python, utilisez :</p>
<div class="highlight-python"><pre>(vp) $ easy_install "GeoAlchemy==0.4.1"</pre>
</div>
</div>
<div class="section" id="changer-le-model">
<h2>Changer le model<a class="headerlink" href="#changer-le-model" title="Permalink to this headline">¶</a></h2>
<p>Pour ajouter la gestion des colonnes géométriques dans votre model, vous devez la
déclarer dans la classe model. GeoAlchemy fournie une classe colonne spécifique
nommée <tt class="docutils literal"><span class="pre">GeometryColumn</span></tt> pour la déclaration des colonnes géométriques.</p>
<p>Voici le code mis à jour :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;The application&#39;s model objects&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">geoalchemy</span> <span class="kn">import</span> <span class="n">GeometryColumn</span><span class="p">,</span> <span class="n">Point</span>
<span class="kn">from</span> <span class="nn">workshopapp.model.meta</span> <span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">Base</span>


<span class="k">def</span> <span class="nf">init_model</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Call me before using any of the tables or classes in the model&quot;&quot;&quot;</span>
    <span class="n">Session</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">Summit</span>
    <span class="k">class</span> <span class="nc">Summit</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
        <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;summits&#39;</span>
        <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;autoload&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                <span class="s">&#39;autoload_with&#39;</span><span class="p">:</span> <span class="n">engine</span>
                <span class="p">}</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">GeometryColumn</span><span class="p">(</span><span class="n">Point</span><span class="p">)</span>
</pre></div>
</div>
<p>Lors de la déclaration de la colonne géométrique le type géométrique doit être
définie (ici <tt class="docutils literal"><span class="pre">Point</span></tt>). Cela est particulièrement utile lors de la liaison de
GeoAlchemy avec SQLAlchemy pour créer des tables géographiques.</p>
</div>
<div class="section" id="changer-le-controlleur">
<h2>Changer le contrôlleur<a class="headerlink" href="#changer-le-controlleur" title="Permalink to this headline">¶</a></h2>
<p>Il est maintenant possible d&#8217;exporter les géométries en chaîne WKT dans le JSON.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">tmpl_context</span> <span class="k">as</span> <span class="n">c</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">pylons.controllers.util</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">pylons.decorators</span> <span class="kn">import</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">workshopapp.model.meta</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">workshopapp.model</span> <span class="kn">import</span> <span class="n">Summit</span>

<span class="kn">from</span> <span class="nn">workshopapp.lib.base</span> <span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">render</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SummitsController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>

    <span class="nd">@jsonify</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">summit</span> <span class="ow">in</span> <span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Summit</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">summits</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">summit</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s">&quot;elevation&quot;</span><span class="p">:</span> <span class="n">summit</span><span class="o">.</span><span class="n">elevation</span><span class="p">,</span>
                <span class="s">&quot;wkt&quot;</span><span class="p">:</span> <span class="n">Session</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">summit</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wkt</span><span class="p">)</span>
                <span class="p">})</span>


        <span class="k">return</span> <span class="n">summits</span>
</pre></div>
</div>
<p>Ouvrez <a class="reference external" href="http://localhost:5000/summits/index">http://localhost:5000/summits/index</a> dans votre navigateur pour voir la
chaîne JSON que le contrôleur <tt class="docutils literal"><span class="pre">summits</span></tt> retourne.</p>
<p>Une chose à noter est que chaque éxécution de
<tt class="docutils literal"><span class="pre">Session.scalar(summits.geom.wkt)</span></tt> génère une requête SQL. Cela est facilement
observable en regardant le retour de la commande <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">server</span></tt>.</p>
<p>Pour éviter ces requêtes SQL additionnelles vous allez utiliser la bibliothèque
Shapely. Ainsi Shapely au lieu de PostGIS sera utilisé pour obtenir une
représentation WKT de la géométrie.</p>
<p>D&#8217;abords installez Shapely (version 1.2) avec :</p>
<div class="highlight-python"><pre>(vp) $ easy_install "Shapely==1.2"</pre>
</div>
<p>Vous pouvez maintenant mettre à jour le fichier
<tt class="docutils literal"><span class="pre">workshopapp/controllers/summits.py</span></tt> avec le contenu suivant :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">from</span> <span class="nn">shapely.wkb</span> <span class="kn">import</span> <span class="n">loads</span>

<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">tmpl_context</span> <span class="k">as</span> <span class="n">c</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">pylons.controllers.util</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">pylons.decorators</span> <span class="kn">import</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">workshopapp.model.meta</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">workshopapp.model</span> <span class="kn">import</span> <span class="n">Summit</span>

<span class="kn">from</span> <span class="nn">workshopapp.lib.base</span> <span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">render</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SummitsController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>

    <span class="nd">@jsonify</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">summit</span> <span class="ow">in</span> <span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Summit</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">wkb</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">summit</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">geom_wkb</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;hex&#39;</span><span class="p">)</span>
            <span class="n">summits</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">summit</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s">&quot;elevation&quot;</span><span class="p">:</span> <span class="n">summit</span><span class="o">.</span><span class="n">elevation</span><span class="p">,</span>
                <span class="s">&quot;wkt&quot;</span><span class="p">:</span> <span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">summit</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">geom_wkb</span><span class="p">))</span><span class="o">.</span><span class="n">wkt</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">summits</span>
</pre></div>
</div>
<p>De nouveau vous pouvez ouvrir <a class="reference external" href="http://localhost:5000/summits/index">http://localhost:5000/summits/index</a> dans le
navigateur et vérifiez la chaîne JSON. Elle doit être identique à la précédente.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Des tests de performances devraient montrer ici une amélioration lorsque
Shapely est utilisé.</p>
</div>
</div>
<div class="section" id="sortie-geojson">
<h2>Sortie GeoJSON<a class="headerlink" href="#sortie-geojson" title="Permalink to this headline">¶</a></h2>
<p>Dans cette section vous allez encore modifier le contrôleur <tt class="docutils literal"><span class="pre">summits</span></tt> afin que
les objets géographiques renvoyés par le contrôleur soient représentés en utilisant
le format GeoJSON. La bibliothèque Python <tt class="docutils literal"><span class="pre">geojson</span></tt> sera utilisée.</p>
<p>Commencez en installant la bibliothèque geojson (version 1.0.1) :</p>
<div class="highlight-python"><pre>(vp) $ easy_install "geojson==1.0.1"</pre>
</div>
<p>Maintenant mettez à jour le fichier <tt class="docutils literal"><span class="pre">workshopapp/controllers/summits.py</span></tt> avec
ce contenu :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">shapely.wkb</span> <span class="kn">import</span> <span class="n">loads</span>
<span class="kn">from</span> <span class="nn">geojson</span> <span class="kn">import</span> <span class="n">Feature</span><span class="p">,</span> <span class="n">FeatureCollection</span><span class="p">,</span> <span class="n">dumps</span>

<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">tmpl_context</span> <span class="k">as</span> <span class="n">c</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">pylons.controllers.util</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">workshopapp.model.meta</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">workshopapp.model</span> <span class="kn">import</span> <span class="n">Summit</span>

<span class="kn">from</span> <span class="nn">workshopapp.lib.base</span> <span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">render</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SummitsController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">summit</span> <span class="ow">in</span> <span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Summit</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">summit</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">geom_wkb</span><span class="p">))</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="n">summit</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span>
                    <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
                        <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">summit</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="s">&quot;elevation&quot;</span><span class="p">:</span> <span class="n">summit</span><span class="o">.</span><span class="n">elevation</span>
                        <span class="p">})</span>
            <span class="n">summits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

        <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
        <span class="k">return</span> <span class="n">dumps</span><span class="p">(</span><span class="n">FeatureCollection</span><span class="p">(</span><span class="n">summits</span><span class="p">))</span>
</pre></div>
</div>
<p>Dans le code ci-dessus les features sont créé à partir des objets lu à partir de
la base de données. Une géométrie Shapely est passé au constructeur <tt class="docutils literal"><span class="pre">Feature</span></tt>,
ce qui montre l&#8217;intégration entre les bibliothèques Shapely et geojson.</p>
<p>Il est également intéressant de noter que le décorateur <tt class="docutils literal"><span class="pre">jsonify</span></tt> n&#8217;est plus
utilisé, la fonction <tt class="docutils literal"><span class="pre">dump</span></tt> de la bibliothèque geojson est utilisée à la place.</p>
</div>
<div class="section" id="calcul-du-buffer">
<h2>Calcul du buffer<a class="headerlink" href="#calcul-du-buffer" title="Permalink to this headline">¶</a></h2>
<p>Ici vous allez étendre le serviec web <tt class="docutils literal"><span class="pre">summits</span></tt> afin qu&#8217;il puisse renvoyer le
buffer d&#8217;une feature donnée. L&#8217;URL sera <tt class="docutils literal"><span class="pre">/summits/buffer/&lt;id&gt;</span></tt> où
<tt class="docutils literal"><span class="pre">id</span></tt> est l&#8217;identifiant de la feature sur laquelle calculer le buffer.</p>
<p>Pour implémenter cette fonctionnalité vous allez ajouter une action <tt class="docutils literal"><span class="pre">buffer</span></tt>
au contrôleur <tt class="docutils literal"><span class="pre">summits</span></tt>. Cette action récupèrera la feature correspondant à
l&#8217;identifiant de la feature fournie, réalisera le calcul du buffer de la feature
dans PostGIS, encodera la géométrie résultante en GeoJSON et renverra la chaîne
GeoJSON.</p>
<p>Vous pouvez mettre à jour le fichier <tt class="docutils literal"><span class="pre">workshopapp/controllers/summits.py</span></tt> avec
le contenu suivant :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">shapely.wkb</span> <span class="kn">import</span> <span class="n">loads</span> <span class="k">as</span> <span class="n">wkbloads</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">asShape</span>
<span class="kn">from</span> <span class="nn">geojson</span> <span class="kn">import</span> <span class="n">GeoJSON</span><span class="p">,</span> <span class="n">Feature</span><span class="p">,</span> <span class="n">FeatureCollection</span><span class="p">,</span> <span class="n">dumps</span><span class="p">,</span> <span class="n">loads</span> <span class="k">as</span> <span class="n">geojsonloads</span>
<span class="kn">from</span> <span class="nn">geoalchemy</span> <span class="kn">import</span> <span class="n">WKBSpatialElement</span><span class="p">,</span> <span class="n">functions</span>

<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">tmpl_context</span> <span class="k">as</span> <span class="n">c</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">pylons.controllers.util</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">workshopapp.model.meta</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">workshopapp.model</span> <span class="kn">import</span> <span class="n">Summit</span>

<span class="kn">from</span> <span class="nn">workshopapp.lib.base</span> <span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">render</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SummitsController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">summit</span> <span class="ow">in</span> <span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Summit</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="n">wkbloads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">summit</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">geom_wkb</span><span class="p">))</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="n">summit</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span>
                    <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
                        <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">summit</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="s">&quot;elevation&quot;</span><span class="p">:</span> <span class="n">summit</span><span class="o">.</span><span class="n">elevation</span>
                        <span class="p">})</span>
            <span class="n">summits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

        <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
        <span class="k">return</span> <span class="n">dumps</span><span class="p">(</span><span class="n">FeatureCollection</span><span class="p">(</span><span class="n">summits</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">buffer_geom</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">functions</span><span class="o">.</span><span class="n">wkb</span><span class="p">(</span><span class="n">Summit</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Summit</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">buffer_geom</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">wkbloads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">buffer_geom</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
        <span class="k">return</span> <span class="n">dumps</span><span class="p">(</span><span class="n">geometry</span><span class="p">)</span>
</pre></div>
</div>
<p>Vous pouvez notez qu&#8217;un seul SELECT est réalisé sur la base de données avec le
code ci-dessus. La même méthode peut être appliquée à l&#8217;action <tt class="docutils literal"><span class="pre">index</span></tt>.</p>
<p><strong>Tâche bonus</strong></p>
<p>Ajoutez une action nommée <tt class="docutils literal"><span class="pre">buffer_shapely</span></tt> qui se base sur Shapely au lieu de
GeoAlchemy et PostGIS pour le calcul du buffer. Et vous pouvez comparer les
performances obtenues lors de l&#8217;utilisation de Shapely ou de PostGIS.</p>
</div>
<div class="section" id="creer-des-features">
<h2>Créer des features<a class="headerlink" href="#creer-des-features" title="Permalink to this headline">¶</a></h2>
<p>Dans cette section vous allez créer un service web permettant d&#8217;ajouter des
sommets à la base de données.</p>
<p>Pour cela vous ajouterez une action <tt class="docutils literal"><span class="pre">create</span></tt> au contrôleur <tt class="docutils literal"><span class="pre">summits</span></tt> qui
parsera la requête POST, chargera la feature GeoJSON, la convertira en WKB avec
Shapely puis créera la feature dans la base de données en utilisant GeoAlchemy.</p>
<p>Vous pouvez maintenant mettre à jour le fichier
<tt class="docutils literal"><span class="pre">workshopapp/controllers/summits.py</span></tt> avec le contenu suivant :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">shapely.wkb</span> <span class="kn">import</span> <span class="n">loads</span> <span class="k">as</span> <span class="n">wkbloads</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">asShape</span>
<span class="kn">from</span> <span class="nn">geojson</span> <span class="kn">import</span> <span class="n">GeoJSON</span><span class="p">,</span> <span class="n">Feature</span><span class="p">,</span> <span class="n">FeatureCollection</span><span class="p">,</span> <span class="n">dumps</span><span class="p">,</span> <span class="n">loads</span> <span class="k">as</span> <span class="n">geojsonloads</span>
<span class="kn">from</span> <span class="nn">geoalchemy</span> <span class="kn">import</span> <span class="n">WKBSpatialElement</span>

<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">tmpl_context</span> <span class="k">as</span> <span class="n">c</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">pylons.controllers.util</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">workshopapp.model.meta</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">workshopapp.model</span> <span class="kn">import</span> <span class="n">Summit</span>

<span class="kn">from</span> <span class="nn">workshopapp.lib.base</span> <span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">render</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SummitsController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">summit</span> <span class="ow">in</span> <span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Summit</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="n">wkbloads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">summit</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">geom_wkb</span><span class="p">))</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="n">summit</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span>
                    <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
                        <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">summit</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="s">&quot;elevation&quot;</span><span class="p">:</span> <span class="n">summit</span><span class="o">.</span><span class="n">elevation</span>
                        <span class="p">})</span>
            <span class="n">summits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

        <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
        <span class="k">return</span> <span class="n">dumps</span><span class="p">(</span><span class="n">FeatureCollection</span><span class="p">(</span><span class="n">summits</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">buffer_geom</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">functions</span><span class="o">.</span><span class="n">wkb</span><span class="p">(</span><span class="n">Summit</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Summit</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">buffer_geom</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">wkbloads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">buffer_geom</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
        <span class="k">return</span> <span class="n">dumps</span><span class="p">(</span><span class="n">geometry</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># read raw POST data</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.input&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;CONTENT_LENGTH&#39;</span><span class="p">]))</span>
        <span class="n">factory</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ob</span><span class="p">:</span> <span class="n">GeoJSON</span><span class="o">.</span><span class="n">to_instance</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="n">geojsonloads</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">object_hook</span><span class="o">=</span><span class="n">factory</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">Feature</span><span class="p">):</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">asShape</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span>
        <span class="n">summit</span> <span class="o">=</span> <span class="n">Summit</span><span class="p">()</span>
        <span class="n">summit</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">WKBSpatialElement</span><span class="p">(</span><span class="nb">buffer</span><span class="p">(</span><span class="n">shape</span><span class="o">.</span><span class="n">wkb</span><span class="p">))</span>
        <span class="n">summit</span><span class="o">.</span><span class="n">elevation</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;elevation&#39;</span><span class="p">]</span>
        <span class="n">summit</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">summit</span><span class="p">)</span>
        <span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">201</span>
        <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&quot;application/json&quot;</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">summit</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="n">dumps</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
</pre></div>
</div>
<p>Vous pouvez alors faire un test pour requêter ce nouveau service en utilisant
<tt class="docutils literal"><span class="pre">curl</span></tt> en ligne de commande :</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>curl http://localhost:5000/summits/create -d <span class="se">\</span>
<span class="s1">&#39;{&quot;geometry&quot;: {&quot;type&quot;: &quot;Point&quot;, &quot;coordinates&quot;: [5.8759399999999999, 45.333889999999997]},</span>
<span class="s1">  &quot;type&quot;: &quot;Feature&quot;, &quot;properties&quot;: {&quot;elevation&quot;: 1876, &quot;name&quot;: &quot;Pas de Montbrun&quot;}, &quot;id&quot;: 2828}&#39;</span> <span class="se">\</span>
-H <span class="s1">&#39;Content-Type:&quot;application/json&quot;&#39;</span>
</pre></div>
</div>
<p>Cette commande doit renvoyer :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;Point&quot;</span><span class="p">,</span> <span class="s">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.8759399999999999</span><span class="p">,</span> <span class="mf">45.333889999999997</span><span class="p">]},</span>
<span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;Feature&quot;</span><span class="p">,</span> <span class="s">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;elevation&quot;</span><span class="p">:</span> <span class="mi">1876</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;Pas de Montbrun&quot;</span><span class="p">},</span> <span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="mi">5133</span><span class="p">}</span>
</pre></div>
</div>
<p>Vous pouvez vérifier qu&#8217;un nouveau sommet a été créé dans la base de données, en
utilisant <tt class="docutils literal"><span class="pre">pgAdmin</span></tt> par exemple.</p>
</div>
<div class="section" id="creer-des-tables-geographiques">
<h2>Créer des tables géographiques<a class="headerlink" href="#creer-des-tables-geographiques" title="Permalink to this headline">¶</a></h2>
<p>Dans le module précédent vous avez appris à créer des tables avec SQLAlchemy lors
de la configuration de l&#8217;application. GeoAlchemy permet de créer des tables
géographiques.</p>
<p>Vous allez convertir la table <tt class="docutils literal"><span class="pre">areas</span></tt> en table géographique avec une colonne
géométrique de type polygone et créer cette table dans la base de données
GeoAlchemy.</p>
<p>D&#8217;abord, supprimer la table <tt class="docutils literal"><span class="pre">areas</span></tt> de la base de données en utilisant pgAdmin
par exemple.</p>
<p>Maintenant mettez à jour le fichier <tt class="docutils literal"><span class="pre">workshopapp/model/__init__.py</span></tt> avec ce
contenu :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;The application&#39;s model objects&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">geoalchemy</span> <span class="kn">import</span> <span class="n">GeometryColumn</span><span class="p">,</span> <span class="n">GeometryDDL</span><span class="p">,</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">workshopapp.model.meta</span> <span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">Base</span>


<span class="k">def</span> <span class="nf">init_model</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Call me before using any of the tables or classes in the model&quot;&quot;&quot;</span>
    <span class="n">Session</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">Summit</span>
    <span class="k">class</span> <span class="nc">Summit</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
        <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;summits&#39;</span>
        <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;autoload&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                <span class="s">&#39;autoload_with&#39;</span><span class="p">:</span> <span class="n">engine</span>
                <span class="p">}</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">GeometryColumn</span><span class="p">(</span><span class="n">Point</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Area</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;areas&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">GeometryColumn</span><span class="p">(</span><span class="n">Polygon</span><span class="p">)</span>

<span class="n">GeometryDDL</span><span class="p">(</span><span class="n">Area</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span>
</pre></div>
</div>
<p>Cette mise à jour implique :</p>
<ul class="simple">
<li>d&#8217;importer <tt class="docutils literal"><span class="pre">GeometryDDL</span></tt> et <tt class="docutils literal"><span class="pre">Polyon</span></tt> de <tt class="docutils literal"><span class="pre">geoalchemy</span></tt> (en plus de
<tt class="docutils literal"><span class="pre">GeometryColumn</span></tt> et <tt class="docutils literal"><span class="pre">Point</span></tt>)</li>
<li>de déclarer une colonne géométrique de type <tt class="docutils literal"><span class="pre">Polygon</span></tt> dans la classe <tt class="docutils literal"><span class="pre">Area</span></tt></li>
<li>d&#8217;utiliser <tt class="docutils literal"><span class="pre">GeometryDDL(Area.__table__)</span></tt> pour permettre à GeoAlchemy de
participer à la création et à la destruction de la table <tt class="docutils literal"><span class="pre">areas</span></tt></li>
</ul>
<p>Vous pouvez maintenant éxécuter la commande <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">setup-app</span></tt> et vérifier que
la table <tt class="docutils literal"><span class="pre">areas</span></tt> et sa colonne géométrie ont été créées :</p>
<div class="highlight-python"><pre>(vp) $ paster setup-app development.ini</pre>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="tilecache.html" title="TileCache"
             >next</a> |</li>
        <li class="right" >
          <a href="pylons.html" title="Pylons et SQLAlchemy"
             >previous</a> |</li>
        <li><a href="../index.html">Python Workshop v0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" >Workshop Python (version française)</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2010, Camptocamp.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.5.
    </div>
  </body>
</html>