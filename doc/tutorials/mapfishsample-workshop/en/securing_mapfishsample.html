<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Securing MapFishSample &mdash; MapFish In Production Workshop v0.1 documentation</title>
    <link rel="stylesheet" href="../static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <link rel="top" title="MapFish In Production Workshop v0.1 documentation" href="../index.html" />
    <link rel="next" title="Going Further With Security" href="going_further_with_security.html" />
    <link rel="prev" title="Studying MapFishSample" href="studying_mapfishsample.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="going_further_with_security.html" title="Going Further With Security"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="studying_mapfishsample.html" title="Studying MapFishSample"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">MapFish In Production Workshop v0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../static/mapfish_white.png" alt="Logo"/>
            </a></p>
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="#">Securing MapFishSample</a><ul>
<li><a class="reference external" href="#create-user-model">Create User Model</a></li>
<li><a class="reference external" href="#set-up-authentication">Set Up Authentication</a></li>
<li><a class="reference external" href="#secure-application">Secure Application</a></li>
<li><a class="reference external" href="#secure-mapfish-web-services">Secure MapFish Web Services</a></li>
<li><a class="reference external" href="#secure-mapserver">Secure MapServer</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="studying_mapfishsample.html"
                                  title="previous chapter">Studying MapFishSample</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="going_further_with_security.html"
                                  title="next chapter">Going Further With Security</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/en/securing_mapfishsample.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="securing-mapfishsample">
<h1>Securing MapFishSample<a class="headerlink" href="#securing-mapfishsample" title="Permalink to this headline">¶</a></h1>
<p>Real-life applications very often require some sort of access control. Access
control can be implemented in MapFish applications using any security toolkit
that can be used with Pylons, including <a class="reference external" href="http://docs.repoze.org/who/">repoze.who</a> and <a class="reference external" href="http://authkit.org/">AuthKit</a>.</p>
<p>In this module we will see how to secure MapFish applications with repoze.who,
which has become the most popular security toolkit for Pylons.</p>
<p>This module is based on a simple, yet realistic, scenario:</p>
<ul class="simple">
<li>The application is available to authenticated users only, so a login
form is immediately displayed when the application is loaded in the
browser.</li>
<li>Every web service composing the application must be protected, including
the POI, MapServer, and TileCache web services.</li>
<li>The HTTP Basic authentication mechanism is used.</li>
<li>Users are stored in the PostgreSQL database.</li>
</ul>
<div class="section" id="create-user-model">
<h2>Create User Model<a class="headerlink" href="#create-user-model" title="Permalink to this headline">¶</a></h2>
<p>In this section we will create a user table in the database. This table will
include the following columns: <tt class="docutils literal"><span class="pre">name</span></tt>, <tt class="docutils literal"><span class="pre">login</span></tt>, <tt class="docutils literal"><span class="pre">password</span></tt>, and
<tt class="docutils literal"><span class="pre">editor</span></tt>. This table will be created at application setup time, using
SQLAlchemy.</p>
<p>The first step involves creating an SQLAlchemy model class for the <tt class="docutils literal"><span class="pre">user</span></tt>
table. Model classes are typically defined in the <tt class="docutils literal"><span class="pre">model/__init__.py</span></tt> file.</p>
<div class="admonition-task-1 admonition ">
<p class="first admonition-title">Task #1</p>
<p>Edit <tt class="docutils literal"><span class="pre">mapfishample/model/__init__.py</span></tt> and append the following content to
the file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;user&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">login</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">editor</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Boolean</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">==</span> <span class="n">password</span>
</pre></div>
</div>
<p>Again, watch your indentation! The <tt class="docutils literal"><span class="pre">class</span></tt> keyword should start at the
first column.</p>
<p class="last">With this code a model class <tt class="docutils literal"><span class="pre">User</span></tt> bound to a table <tt class="docutils literal"><span class="pre">user</span></tt> is defined.
Five properties are defined in the class, each corresponds to a table
column. The <tt class="docutils literal"><span class="pre">validate_password</span></tt> function will be called by the security
toolkit to validate the password entered by the user.</p>
</div>
<p>Once the model class is defined, the corresponding table can be created in the
database with the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">setup-app</span></tt> command. As its name suggests the goal
of this command is to set up the application. This command actually executes
the <tt class="docutils literal"><span class="pre">setup_app</span></tt> function that is defined in the <tt class="docutils literal"><span class="pre">websetup.py</span></tt> file.</p>
<div class="admonition-task-2 admonition ">
<p class="first admonition-title">Task #2</p>
<p>Run <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">setup-app</span></tt> to create the <tt class="docutils literal"><span class="pre">user</span></tt> table in the database:</p>
<div class="highlight-python"><pre>$ ./buildout/bin/paster setup-app development.ini</pre>
</div>
<p class="last">Open <tt class="docutils literal"><span class="pre">pgadmin</span></tt> and verify that the table has been created, and that
its columns are as expected.</p>
</div>
<p>For the <tt class="docutils literal"><span class="pre">user</span></tt> table to be useful users must be inserted into it. Again
this is done at application setup time, so the code to insert users in
the table goes to the <tt class="docutils literal"><span class="pre">websetup.py</span></tt> file.</p>
<div class="admonition-task-3 admonition ">
<p class="first admonition-title">Task #3</p>
<p>Edit <tt class="docutils literal"><span class="pre">mapfishsample/websetup.py</span></tt> again, and append the following
content to the <tt class="docutils literal"><span class="pre">setup_app</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">mapfishsample.model</span> <span class="kn">import</span> <span class="n">User</span>

<span class="c"># create user &quot;Johane&quot;</span>
<span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
<span class="n">u1</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Johane&quot;</span>
<span class="n">u1</span><span class="o">.</span><span class="n">login</span> <span class="o">=</span> <span class="s">&quot;johane&quot;</span>
<span class="n">u1</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s">&quot;johane&quot;</span>
<span class="n">u1</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c"># create user &quot;Alix&quot;</span>
<span class="n">u2</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
<span class="n">u2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Alix&quot;</span>
<span class="n">u2</span><span class="o">.</span><span class="n">login</span> <span class="o">=</span> <span class="s">&quot;alix&quot;</span>
<span class="n">u2</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s">&quot;alix&quot;</span>
<span class="n">u2</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c"># add them to the database</span>
<span class="n">Session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">])</span>
<span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<p>Run <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">setup-app</span></tt> again, to execute the <tt class="docutils literal"><span class="pre">setup_app</span></tt> function
again, and insert our two users:</p>
<div class="highlight-python"><pre>$ ./buildout/bin/paster setup-app development.ini</pre>
</div>
<p class="last">Open <tt class="docutils literal"><span class="pre">pgadmin</span></tt> one more time and verify that the <tt class="docutils literal"><span class="pre">user</span></tt> table
contains Johane and Alix.</p>
</div>
<p>We now have our <tt class="docutils literal"><span class="pre">user</span></tt> table, with two users inserted into it. We&#8217;re
ready to set up authentication.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For security reasons passwords should actually be encrypted in the
database. This is ommitted here, for the sake of simplicity.</p>
</div>
</div>
<div class="section" id="set-up-authentication">
<h2>Set Up Authentication<a class="headerlink" href="#set-up-authentication" title="Permalink to this headline">¶</a></h2>
<p>In this section we will set up authentication in MapFishSample, using
<tt class="docutils literal"><span class="pre">repoze.who</span></tt>. This is done by adding code to two files:
<tt class="docutils literal"><span class="pre">mapfishsample/lib/auth.py</span></tt> and <tt class="docutils literal"><span class="pre">mapfishsample/config/middleware.py</span></tt>.  The
<tt class="docutils literal"><span class="pre">auth.py</span></tt> file doesn&#8217;t exist yet, it will be created for the specific purpose
of setting up authentication.</p>
<p>Prior to using <tt class="docutils literal"><span class="pre">repoze.who</span></tt> we need to install it in the Python
environment. For that we just need to make <tt class="docutils literal"><span class="pre">repoze.who</span></tt> a dependency
of MapFishSample.</p>
<div class="admonition-task-4 admonition ">
<p class="first admonition-title">Task #4</p>
<p>Edit <tt class="docutils literal"><span class="pre">setup.py</span></tt> and <tt class="docutils literal"><span class="pre">repoze.who.plugins.sa==1.0</span></tt> to the
<tt class="docutils literal"><span class="pre">install_requires</span></tt> array:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">install_requires</span><span class="o">=</span><span class="p">[</span>
    <span class="s">&quot;psycopg2&gt;=2.2.0,&lt;=2.2.99&quot;</span><span class="p">,</span>
    <span class="s">&quot;mapfish&gt;=2.0,&lt;=2.2.99&quot;</span><span class="p">,</span>
    <span class="s">&quot;httplib2&gt;=0.6.0,&lt;=0.6.99&quot;</span><span class="p">,</span>
    <span class="s">&quot;Babel&lt;=0.9.99&quot;</span><span class="p">,</span>
    <span class="s">&quot;TileCache&gt;=2.10,&lt;=2.10.99&quot;</span><span class="p">,</span>
    <span class="s">&quot;GeoFormAlchemy&gt;=0.2,&lt;=0.3.99&quot;</span><span class="p">,</span>
    <span class="s">&quot;repoze.who.plugins.sa==1.0&quot;</span><span class="p">,</span>
<span class="p">],</span>
</pre></div>
</div>
<p>The last entry in the array sets <tt class="docutils literal"><span class="pre">repoze.who.plugins.sa</span></tt> as a dependency
of MapFishSample. <a class="reference external" href="http://code.gustavonarea.net/repoze.who.plugins.sa/">repoze.who.plugins.sa</a> is a <tt class="docutils literal"><span class="pre">repoze.who</span></tt>
plugin to work with SQLAlchemy. <tt class="docutils literal"><span class="pre">repoze.who.plugins.sa</span></tt> requires
<tt class="docutils literal"><span class="pre">repoze.who</span></tt>, so the installation of <tt class="docutils literal"><span class="pre">repoze.who.plugins.sa</span></tt> will
automatically install <tt class="docutils literal"><span class="pre">repoze.who</span></tt>.</p>
<p>Execute the <tt class="docutils literal"><span class="pre">eggs</span></tt> and <tt class="docutils literal"><span class="pre">modwsgi</span></tt> Buildout parts to install the
<tt class="docutils literal"><span class="pre">repoze.who</span></tt> packages, and recreate the modwsgi script:</p>
<div class="last highlight-python"><pre>$ ./buildout/bin/buildout -c buildout_mine.cfg install eggs</pre>
</div>
</div>
<p>With <tt class="docutils literal"><span class="pre">repoze.who</span></tt> installed we can now go on with setting up the
authentication. The main task for that involves writing a WSGI middleware
dedicated to the authentication. This is typically done in <tt class="docutils literal"><span class="pre">lib/auth.py</span></tt>.</p>
<div class="admonition-task-5 admonition ">
<p class="first admonition-title">Task #5</p>
<p>Create the file <tt class="docutils literal"><span class="pre">mapfishsample/lib/auth.py</span></tt>, and open it in your editor,
and add this content to it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">repoze.who.middleware</span> <span class="kn">import</span> <span class="n">PluggableAuthenticationMiddleware</span>
<span class="kn">from</span> <span class="nn">repoze.who.classifiers</span> <span class="kn">import</span> <span class="n">default_request_classifier</span>
<span class="kn">from</span> <span class="nn">repoze.who.classifiers</span> <span class="kn">import</span> <span class="n">default_challenge_decider</span>

<span class="kn">from</span> <span class="nn">repoze.who.plugins.sa</span> <span class="kn">import</span> <span class="n">SQLAlchemyAuthenticatorPlugin</span>
<span class="kn">from</span> <span class="nn">repoze.who.plugins.sa</span> <span class="kn">import</span> <span class="n">SQLAlchemyUserMDPlugin</span>
<span class="kn">from</span> <span class="nn">repoze.who.plugins.basicauth</span> <span class="kn">import</span> <span class="n">BasicAuthPlugin</span>

<span class="kn">from</span> <span class="nn">mapfishsample.model</span> <span class="kn">import</span> <span class="n">meta</span><span class="p">,</span> <span class="n">User</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">AuthMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>

    <span class="n">basicauth</span> <span class="o">=</span> <span class="n">BasicAuthPlugin</span><span class="p">(</span><span class="s">&#39;repoze.who&#39;</span><span class="p">)</span>

    <span class="n">authenticator</span> <span class="o">=</span> <span class="n">SQLAlchemyAuthenticatorPlugin</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="p">)</span>
    <span class="n">authenticator</span><span class="o">.</span><span class="n">translations</span><span class="p">[</span><span class="s">&#39;user_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;login&#39;</span>

    <span class="n">mdprovider</span> <span class="o">=</span> <span class="n">SQLAlchemyUserMDPlugin</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="p">)</span>
    <span class="n">mdprovider</span><span class="o">.</span><span class="n">translations</span><span class="p">[</span><span class="s">&#39;user_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;login&#39;</span>

    <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;basicauth&#39;</span><span class="p">,</span> <span class="n">basicauth</span><span class="p">)]</span>
    <span class="n">authenticators</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;sqlalchemy&#39;</span><span class="p">,</span> <span class="n">authenticator</span><span class="p">)]</span>
    <span class="n">challengers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;basicauth&#39;</span><span class="p">,</span> <span class="n">basicauth</span><span class="p">)]</span>
    <span class="n">mdproviders</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;sqlalchemy&#39;</span><span class="p">,</span> <span class="n">mdprovider</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">PluggableAuthenticationMiddleware</span><span class="p">(</span>
        <span class="n">app</span><span class="p">,</span>
        <span class="n">identifiers</span><span class="p">,</span>
        <span class="n">authenticators</span><span class="p">,</span>
        <span class="n">challengers</span><span class="p">,</span>
        <span class="n">mdproviders</span><span class="p">,</span>
        <span class="n">default_request_classifier</span><span class="p">,</span>
        <span class="n">default_challenge_decider</span><span class="p">,</span>
        <span class="c">#log_stream = log,</span>
        <span class="c">#log_level = logging.DEBUG</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">AuthMiddleware</span></tt> function returns the WSGI middleware dedicated to
the authentication. This middleware is configured with parameters
that specify how we want authentication to work.</p>
<p>The <tt class="docutils literal"><span class="pre">basicauth</span></tt> object specifies the authentication method we use, HTTP
Basic Authentication here.</p>
<p>The <tt class="docutils literal"><span class="pre">authenticator</span></tt> object takes care of validating the user credentials,
and returning the user object if the credentials can be validated.</p>
<p class="last">The <tt class="docutils literal"><span class="pre">mdprovider</span></tt> object allows obtaining more information about the
authenticated user. In our case the <tt class="docutils literal"><span class="pre">mdprovider</span></tt> object will provide us
with the information of whether the user is an editor or not.</p>
</div>
<p>We have our authentication middleware ready. We now need to plug it
into the WSGI stack defined in <tt class="docutils literal"><span class="pre">config/middleware.py</span></tt>.</p>
<div class="admonition-task-6 admonition ">
<p class="first admonition-title">Task #6</p>
<p>Edit <tt class="docutils literal"><span class="pre">mapfishsample/config/middleware.py</span></tt> and insert the authentication
middleware in the WSGI stack. As an help here&#8217;s an excerpt of the
<tt class="docutils literal"><span class="pre">middleware.py</span></tt> file:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">asbool</span><span class="p">(</span><span class="n">full_stack</span><span class="p">):</span>
    <span class="c"># Handle Python exceptions</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">ErrorHandler</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">global_conf</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;pylons.errorware&#39;</span><span class="p">])</span>

    <span class="c"># Display error documents for 401, 403, 404 status codes (and</span>
    <span class="c"># 500 when debug is disabled)</span>
    <span class="k">if</span> <span class="n">asbool</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]):</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">StatusCodeRedirect</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">StatusCodeRedirect</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="p">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="mi">403</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span> <span class="mi">500</span><span class="p">])</span>

<span class="c"># The Authentication middleware</span>
<span class="c"># Note: AuthMiddleware must wrap StatusCodeRedirect or AuthMiddleware</span>
<span class="c"># won&#39;t see 401 (or 403) responses from the error controller.</span>
<span class="kn">from</span> <span class="nn">mapfishsample.lib.auth</span> <span class="kn">import</span> <span class="n">AuthMiddleware</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">AuthMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c"># Establish the Registry for this application</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">RegistryManager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The last thing to do is to modify the Apache mod_wsgi configuration to make
mod_wsgi pass the user credentials to the WSGI application (MapFishSample).</p>
<div class="admonition-task-7 admonition ">
<p class="first admonition-title">Task #7</p>
<p>Edit <tt class="docutils literal"><span class="pre">apache/wsgi.conf.in</span></tt>, and uncomment this line:</p>
<div class="highlight-python"><pre>WSGIPassAuthorization On</pre>
</div>
<p>Run the <tt class="docutils literal"><span class="pre">template</span></tt> Buildout part:</p>
<div class="highlight-python"><pre>$ ./buildout/bin/buildout -c buildout_mine.cfg install template</pre>
</div>
<p>And reload Apache:</p>
<div class="highlight-python"><pre>$ sudo /etc/init.d/apache2 reload</pre>
</div>
<p class="last">You can now open <a class="reference external" href="http://mapfish">http://mapfish</a> again in the browser, and verify that the
application continues to function properly.</p>
</div>
<p>The authentication bits are in place, but we haven&#8217;t secure the application
yet, and this is what we&#8217;re going to do in the next section.</p>
</div>
<div class="section" id="secure-application">
<h2>Secure Application<a class="headerlink" href="#secure-application" title="Permalink to this headline">¶</a></h2>
<p>We want to control access to every web service of the application - so that the
unauthenticated user gets a login form each time he or she attempts to access
a resource of the application.</p>
<p>For that we&#8217;re going to set up access-control at the lowest level, i.e.  in the
<tt class="docutils literal"><span class="pre">BaseController</span></tt> class defined in <tt class="docutils literal"><span class="pre">lib/base.py</span></tt>. The <tt class="docutils literal"><span class="pre">BaseController</span></tt>
class is the parent class of every controller of the application.</p>
<div class="admonition-task-8 admonition ">
<p class="first admonition-title">Task #8</p>
<p>Edit <tt class="docutils literal"><span class="pre">mapfishsample/lib/base.py</span></tt> and add a <tt class="docutils literal"><span class="pre">__before__</span></tt> function
to the <tt class="docutils literal"><span class="pre">BaseController</span></tt> class:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;The base Controller API</span>

<span class="sd">Provides the BaseController class for subclassing.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">pylons.controllers</span> <span class="kn">import</span> <span class="n">WSGIController</span>
<span class="kn">from</span> <span class="nn">pylons.templating</span> <span class="kn">import</span> <span class="n">render_mako</span> <span class="k">as</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">tmpl_context</span> <span class="k">as</span> <span class="n">c</span>
<span class="kn">from</span> <span class="nn">pylons.controllers.util</span> <span class="kn">import</span> <span class="n">abort</span>

<span class="kn">from</span> <span class="nn">mapfishsample.model.meta</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="k">class</span> <span class="nc">BaseController</span><span class="p">(</span><span class="n">WSGIController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__before__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;repoze.who.identity&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">identity</span> <span class="ow">and</span> <span class="n">identity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoke the Controller&quot;&quot;&quot;</span>
        <span class="c"># WSGIController.__call__ dispatches to the Controller method</span>
        <span class="c"># the request is routed to. This routing information is</span>
        <span class="c"># available in environ[&#39;pylons.routes_dict&#39;]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">WSGIController</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">Session</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
</pre></div>
</div>
<p>When a request comes in and is directed to a controller, the <tt class="docutils literal"><span class="pre">__before__</span></tt>
function of the controller is invoked before anything else.</p>
<p>Our implementation of <tt class="docutils literal"><span class="pre">__before__</span></tt> checks if the <tt class="docutils literal"><span class="pre">repoze.who</span></tt>
middleware has identified the user already, i.e. if the user is already
logged in. If the user isn&#8217;t logged in, a <tt class="docutils literal"><span class="pre">401</span> <span class="pre">Unauthorized</span></tt> response is
sent back, which will make the <tt class="docutils literal"><span class="pre">repoze.who</span></tt> middleware send an
authentication challenge to the browser, which will further make the
browser open a login window. If the user has already logged in, the
authenticated user is stored in the context object (<tt class="docutils literal"><span class="pre">c</span></tt>), for later use
by other functions of the controller.</p>
<p>For this change to be available in the instance run in Apache
you need to reload Apache:</p>
<div class="last highlight-python"><pre>$ sudo /etc/init.d/apache2 reload</pre>
</div>
</div>
<p>By adding a <tt class="docutils literal"><span class="pre">__before__</span></tt> function to base controller that sends a <tt class="docutils literal"><span class="pre">401</span>
<span class="pre">Unauthorized</span></tt> response if the user isn&#8217;t identified, we have added
access-control to all web services of the application, including the POI
MapFish web service, and the TileCache web service.</p>
<div class="admonition-task-9 admonition ">
<p class="first admonition-title">Task #9</p>
<p>In this task you&#8217;re going to verify that the POIS and TileCache web
services are secured.</p>
<p>Open <a class="reference external" href="http://mapfish/mapfishsample/sample/wsgi/pois">http://mapfish/mapfishsample/sample/wsgi/pois</a> in the
browser, and verify that you get a login window. Do not
log in for now.</p>
<p>Do the same with <a class="reference external" href="http://mapfish/mapfishsample/sample/wsgi/tilecache">http://mapfish/mapfishsample/sample/wsgi/tilecache</a>. Log in
with either <tt class="docutils literal"><span class="pre">johane/johane</span></tt> or <tt class="docutils literal"><span class="pre">alix/alix</span></tt>.</p>
<p class="last">To clear the credentials in the browser you can do <tt class="docutils literal"><span class="pre">CTRL+SHIT+DEL</span></tt>,
select <tt class="docutils literal"><span class="pre">Active</span> <span class="pre">Logins</span></tt> in the <tt class="docutils literal"><span class="pre">Details</span></tt> list, and hit the <tt class="docutils literal"><span class="pre">Clear</span> <span class="pre">Now</span></tt>
button.</p>
</div>
<p>In fact the entry point controller (<tt class="docutils literal"><span class="pre">controller/entry.py</span></tt>) isn&#8217;t secured yet.
This is because this controller defines its own <tt class="docutils literal"><span class="pre">__before__</span></tt> function. So,
for the authentication to work for this controller as well, we need to modify
the <tt class="docutils literal"><span class="pre">__before__</span></tt> function to make it call its parent.</p>
<div class="admonition-task-10 admonition ">
<p class="first admonition-title">Task #10</p>
<p>If you haven&#8217;t cleared your credentials in the browser at the end of the
previous task do it now.</p>
<p>Now open <a class="reference external" href="http://mapfish">http://mapfish</a> in the browser, and observe that you effectively
don&#8217;t get a login window.</p>
<p>To remedy that edit <tt class="docutils literal"><span class="pre">mapfishsample/controllers/entry.py</span></tt> and modify the
<tt class="docutils literal"><span class="pre">__before__</span></tt> function as done in the following code excerpt:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tmpl_context</span> <span class="k">as</span> <span class="n">c</span>
<span class="kn">from</span> <span class="nn">pylons.controllers.util</span> <span class="kn">import</span> <span class="n">abort</span>
<span class="kn">from</span> <span class="nn">pylons.i18n</span> <span class="kn">import</span> <span class="n">set_lang</span>

<span class="kn">from</span> <span class="nn">mapfishsample.lib.base</span> <span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">render</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">EntryController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__before__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># call our parent for access-control</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EntryController</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__before__</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="s">&quot;debug&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span>
        <span class="n">c</span><span class="o">.</span><span class="n">lang</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;lang&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;default_lang&quot;</span><span class="p">)))</span>
        <span class="n">set_lang</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&quot;index.html&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apiloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&quot;apiloader.js&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apihelp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&quot;apihelp.html&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p class="last">You can now reload <a class="reference external" href="http://mapfish">http://mapfish</a>. You should get a login window this time!</p>
</div>
<p>MapFishSample is secured!</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is to be noted that there&#8217;s no access control for the static resources
when the application is served by Apache. Indeed, as we&#8217;ve seen previously
the static resources are served by Apache directly.</p>
</div>
</div>
<div class="section" id="secure-mapfish-web-services">
<h2>Secure MapFish Web Services<a class="headerlink" href="#secure-mapfish-web-services" title="Permalink to this headline">¶</a></h2>
<p>In this section we&#8217;re going to go one step further with access-control for the
POI MapFish web service. We&#8217;re going to modify the <tt class="docutils literal"><span class="pre">pois</span></tt> controller in such
a way that only <em>editors</em> are able to created, update, or delete POIs.</p>
<p>With everything now in place adding this is straightforward.</p>
<div class="admonition-task-11 admonition ">
<p class="first admonition-title">Task #11</p>
<p>Open <tt class="docutils literal"><span class="pre">mapfishsample/controllers/pois.py</span></tt> in your editor, and modify
the <tt class="docutils literal"><span class="pre">create</span></tt>, <tt class="docutils literal"><span class="pre">update</span></tt>, and <tt class="docutils literal"><span class="pre">delete</span></tt> methods so they return
a <tt class="docutils literal"><span class="pre">403</span> <span class="pre">Forbidden</span></tt> response if the user isn&#8217;t an <em>editor</em>.</p>
<p>Here&#8217;s what <tt class="docutils literal"><span class="pre">update</span></tt> function will look like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@geojsonify</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;PUT /id: Update an existing feature.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">editor</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>
<p>You can do the same for <tt class="docutils literal"><span class="pre">create</span></tt> and <tt class="docutils literal"><span class="pre">delete</span></tt>.</p>
<p class="last">Open or reload <a class="reference external" href="http://mapfish">http://mapfish</a> in the browser, log in with <tt class="docutils literal"><span class="pre">alix/alix</span></tt>,
and verify in the FireBug console that you get <tt class="docutils literal"><span class="pre">403</span></tt> errors when
attempting to create, update, or delete POIs.</p>
</div>
<div class="admonition-bonus-task-1 admonition ">
<p class="first admonition-title">Bonus Task #1</p>
<p class="last">As a bonus task you can attempt to modify the application to disable the
<tt class="docutils literal"><span class="pre">editing</span></tt> button in the UI if the user isn&#8217;t an editor.</p>
</div>
</div>
<div class="section" id="secure-mapserver">
<h2>Secure MapServer<a class="headerlink" href="#secure-mapserver" title="Permalink to this headline">¶</a></h2>
<p>MapServer is external to the MapFishSample application, so controlling
access to it isn&#8217;t as straightforward.</p>
<p>A solution to introducing access-control for MapServer, and reusing what we
have put in place in this module, involves implementing a controller that
proxies requests and responses to and from MapServer, respectively.</p>
<div class="admonition-task-12 admonition ">
<p class="first admonition-title">Task #12</p>
<p>As a first task for this section you&#8217;re going to create the controller for
proxying requests and responses to and from MapServer.</p>
<p>Create the file <tt class="docutils literal"><span class="pre">mapfishsample/controllers/mapserverproxy.py</span></tt>
with this content:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">httplib2</span>
<span class="kn">import</span> <span class="nn">urllib</span>

<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span>
<span class="kn">from</span> <span class="nn">pylons.controllers.util</span> <span class="kn">import</span> <span class="n">abort</span>

<span class="kn">from</span> <span class="nn">mapfishsample.lib.base</span> <span class="kn">import</span> <span class="n">BaseController</span>
<span class="kn">from</span> <span class="nn">mapfishsample.model</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">mapfishsample.model.meta</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MapserverproxyController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># params hold the params to send to MapServer</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="c"># get query string</span>
        <span class="n">query_string</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="c"># get URL</span>
        <span class="n">_url</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;mapserv.url&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;?&#39;</span> <span class="o">+</span> <span class="n">query_string</span>

        <span class="c"># get method</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span>

        <span class="c"># get body</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;POST&quot;</span><span class="p">,</span> <span class="s">&quot;PUT&quot;</span><span class="p">):</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>

        <span class="c"># forward request to target (without Host Header)</span>
        <span class="n">http</span> <span class="o">=</span> <span class="n">httplib2</span><span class="o">.</span><span class="n">Http</span><span class="p">()</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;Host&quot;</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">_url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">502</span><span class="p">)</span> <span class="c"># Bad Gateway</span>

        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">):</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&quot;Content-Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="s">&quot;content-type&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">406</span><span class="p">)</span> <span class="c"># Not Acceptable</span>

        <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span>
        <span class="k">return</span> <span class="n">content</span>
</pre></div>
</div>
<p class="last">Study the code of the controller.</p>
</div>
<div class="admonition-task-13 admonition ">
<p class="first admonition-title">Task #13</p>
<p>For the <tt class="docutils literal"><span class="pre">mapserverproxy</span></tt> controller to be operational a few
things remain to be done.</p>
<p>By studying the code of the controller you may have observed that the URL to
MapServer must be set in the application configuration, through the
<tt class="docutils literal"><span class="pre">mapserv.url</span></tt> variable.</p>
<p>Edit <tt class="docutils literal"><span class="pre">production.ini.in</span></tt> and add the following lines anywhere in the
<tt class="docutils literal"><span class="pre">[app.main]</span></tt> section (for example after the setting of
<tt class="docutils literal"><span class="pre">default_lang</span></tt>):</p>
<div class="highlight-python"><pre># MapServer URL
mapserv.url = ${mapserv_url}</pre>
</div>
<p>Also, as for every controller, a <em>route</em> to this controller is needed.</p>
<p>Edit <tt class="docutils literal"><span class="pre">mapfishsample/config/routing.py</span></tt> and add these lines:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># MapServer Proxy route</span>
<span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/mapserv&#39;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;mapserverproxy&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;index&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>At this stage all the necessary code is in place. You can now rerun
the <tt class="docutils literal"><span class="pre">template</span></tt> part of Buildout:</p>
<div class="highlight-python"><pre>$ ./buildout/bin/buildout -c buildout_mine.cfg install template</pre>
</div>
<p>Reload Apache:</p>
<div class="highlight-python"><pre>$ sudo /etc/init.d/apache2 reload</pre>
</div>
<p class="last">And open <a class="reference external" href="http://mapfish/mapfishsample/sample/wsgi/mapserv">http://mapfish/mapfishsample/sample/wsgi/mapserv</a> in
the browser. If your credentials are cleared in the browser
you should get a login window.</p>
</div>
<p>Securing MapServer through a proxy controller in the application takes a few
lines of code only. And it is to be noted that, with this few lines of code,
all the power and flexibility of <tt class="docutils literal"><span class="pre">repoze.who</span></tt> can be leveraged.</p>
<div class="admonition-task-14 admonition ">
<p class="first admonition-title">Task #14</p>
<p>As a very last task you&#8217;re going to change the URL used by the client code
for the POI WMS layer.</p>
<p>Edit <tt class="docutils literal"><span class="pre">mapfishsample/templates/globals.js.in</span></tt> and change the value of
<tt class="docutils literal"><span class="pre">App.mapservURL</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">App</span><span class="o">.</span><span class="n">mapservURL</span> <span class="o">=</span> <span class="s">&quot;$${url(controller=&#39;mapserverproxy&#39;, action=&#39;index&#39;, qualified=True)}&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>You also need to edit <tt class="docutils literal"><span class="pre">mapfishsample/public/app/lib/App/Map.js</span></tt> to rely
on <tt class="docutils literal"><span class="pre">App.mapservURL</span></tt> again for the POI WMS layer:</p>
<div class="highlight-python"><pre>poisLayer = new OpenLayers.Layer.WMS(
    'POIS',
    App.mapservURL,
    {
        layers: ['sustenance'],
        transparent: true
    },
    {
        singleTile: true
    }
);</pre>
</div>
<p>At this stage all the necessary code is in place. You can now rerun
the <tt class="docutils literal"><span class="pre">template</span></tt> part of Buildout:</p>
<div class="highlight-python"><pre>$ ./buildout/bin/buildout -c buildout_mine.cfg install template</pre>
</div>
<p class="last">Open or <a class="reference external" href="http://mapfish">http://mapfish</a> and observe in the FireBug Net tab that
our MapServer proxy is now used to access MapServer.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="going_further_with_security.html" title="Going Further With Security"
             >next</a> |</li>
        <li class="right" >
          <a href="studying_mapfishsample.html" title="Studying MapFishSample"
             >previous</a> |</li>
        <li><a href="../index.html">MapFish In Production Workshop v0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2011, Camptocamp.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.5.
    </div>
  </body>
</html>